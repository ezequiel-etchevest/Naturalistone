{"version":3,"names":["_Symbol$for","_classPrivateFieldLooseBase","receiver","privateKey","Object","prototype","hasOwnProperty","call","TypeError","id","_classPrivateFieldLooseKey","name","fetchWithNetworkError","ErrorWithCause","emitSocketProgress","getSocketHost","EventManager","AuthError","Socket","packageJson","stripSlash","url","replace","handleJSONResponse","res","status","jsonPromise","json","ok","errMsg","statusText","errData","message","requestId","Error","allowedHeadersCache","Map","_companionHeaders","_getUrl","_requestSocketToken","Symbol","for","RequestClient","constructor","uppy","opts","getQueue","defineProperty","value","_getUrl2","writable","file","postBody","remote","post","body","token","onReceiveResponse","bind","companionHeaders","setCompanionHeaders","headers","hostname","companion","getState","host","companionUrl","defaultHeaders","Accept","VERSION","_ref","state","has","get","setState","preflight","path","allowedHeadersCached","fallbackAllowedHeaders","promise","response","fetch","method","header","set","log","allowedHeaders","split","map","headerName","trim","toLowerCase","err","delete","preflightAndHeaders","Promise","all","fromEntries","entries","filter","_ref2","includes","request","_ref3","data","skipPostResponse","signal","credentials","companionCookiesRule","JSON","stringify","isAuthError","cause","options","undefined","uploadRemoteFile","reqBody","serverToken","connectToServerSocket","queueRequestSocketToken","wrapPromiseFunction","priority","abortOn","files","setFileState","getFile","_err$cause","emit","queue","resolve","reject","socket","target","autoOpen","eventManager","queuedRequest","onFileRemove","send","abort","onPause","isPaused","run","open","onPauseAll","onCancelAll","_temp","reason","onResumeAll","error","onRetry","isOpen","onRetryAll","on","progressData","assign","useFastRemoteRetry","close","done","uploadResp","uploadURL","test","version"],"sources":["RequestClient.js"],"sourcesContent":["'use strict'\n\nimport fetchWithNetworkError from '@uppy/utils/lib/fetchWithNetworkError'\nimport ErrorWithCause from '@uppy/utils/lib/ErrorWithCause'\nimport emitSocketProgress from '@uppy/utils/lib/emitSocketProgress'\nimport getSocketHost from '@uppy/utils/lib/getSocketHost'\nimport EventManager from '@uppy/utils/lib/EventManager'\n\nimport AuthError from './AuthError.js'\nimport Socket from './Socket.js'\n\nimport packageJson from '../package.json'\n\n// Remove the trailing slash so we can always safely append /xyz.\nfunction stripSlash (url) {\n  return url.replace(/\\/$/, '')\n}\n\nasync function handleJSONResponse (res) {\n  if (res.status === 401) {\n    throw new AuthError()\n  }\n\n  const jsonPromise = res.json()\n  if (res.ok) {\n    return jsonPromise\n  }\n\n  let errMsg = `Failed request with status: ${res.status}. ${res.statusText}`\n  try {\n    const errData = await jsonPromise\n    errMsg = errData.message ? `${errMsg} message: ${errData.message}` : errMsg\n    errMsg = errData.requestId\n      ? `${errMsg} request-Id: ${errData.requestId}`\n      : errMsg\n  } catch {\n    /* if the response contains invalid JSON, let's ignore the error */\n  }\n  throw new Error(errMsg)\n}\n\n// todo pull out into core instead?\nconst allowedHeadersCache = new Map()\n\nexport default class RequestClient {\n  static VERSION = packageJson.version\n\n  #companionHeaders\n\n  constructor (uppy, opts, getQueue) {\n    this.uppy = uppy\n    this.opts = opts\n    this.getQueue = getQueue\n    this.onReceiveResponse = this.onReceiveResponse.bind(this)\n    this.#companionHeaders = opts?.companionHeaders\n  }\n\n  setCompanionHeaders (headers) {\n    this.#companionHeaders = headers\n  }\n\n  [Symbol.for('uppy test: getCompanionHeaders')] () {\n    return this.#companionHeaders\n  }\n\n  get hostname () {\n    const { companion } = this.uppy.getState()\n    const host = this.opts.companionUrl\n    return stripSlash(companion && companion[host] ? companion[host] : host)\n  }\n\n  async headers () {\n    const defaultHeaders = {\n      Accept: 'application/json',\n      'Content-Type': 'application/json',\n      'Uppy-Versions': `@uppy/companion-client=${RequestClient.VERSION}`,\n    }\n\n    return {\n      ...defaultHeaders,\n      ...this.#companionHeaders,\n    }\n  }\n\n  onReceiveResponse ({ headers }) {\n    const state = this.uppy.getState()\n    const companion = state.companion || {}\n    const host = this.opts.companionUrl\n\n    // Store the self-identified domain name for the Companion instance we just hit.\n    if (headers.has('i-am') && headers.get('i-am') !== companion[host]) {\n      this.uppy.setState({\n        companion: { ...companion, [host]: headers.get('i-am') },\n      })\n    }\n  }\n\n  #getUrl (url) {\n    if (/^(https?:|)\\/\\//.test(url)) {\n      return url\n    }\n    return `${this.hostname}/${url}`\n  }\n\n  /*\n    Preflight was added to avoid breaking change between older Companion-client versions and\n    newer Companion versions and vice-versa. Usually the break will manifest via CORS errors because a\n    version of companion-client could be sending certain headers to a version of Companion server that\n    does not support those headers. In which case, the default preflight would lead to CORS.\n    So to avoid those errors, we do preflight ourselves, to see what headers the Companion server\n    we are communicating with allows. And based on that, companion-client knows what headers to\n    send and what headers to not send.\n\n    The preflight only happens once throughout the life-cycle of a certain\n    Companion-client <-> Companion-server pair (allowedHeadersCache).\n    Subsequent requests use the cached result of the preflight.\n    However if there is an error retrieving the allowed headers, we will try again next time\n  */\n  async preflight (path) {\n    const allowedHeadersCached = allowedHeadersCache.get(this.hostname)\n    if (allowedHeadersCached != null) return allowedHeadersCached\n\n    const fallbackAllowedHeaders = [\n      'accept',\n      'content-type',\n      'uppy-auth-token',\n    ]\n\n    const promise = (async () => {\n      try {\n        const response = await fetch(this.#getUrl(path), { method: 'OPTIONS' })\n\n        const header = response.headers.get('access-control-allow-headers')\n        if (header == null || header === '*') {\n          allowedHeadersCache.set(this.hostname, fallbackAllowedHeaders)\n          return fallbackAllowedHeaders\n        }\n\n        this.uppy.log(\n          `[CompanionClient] adding allowed preflight headers to companion cache: ${this.hostname} ${header}`,\n        )\n\n        const allowedHeaders = header\n          .split(',')\n          .map((headerName) => headerName.trim().toLowerCase())\n        allowedHeadersCache.set(this.hostname, allowedHeaders)\n        return allowedHeaders\n      } catch (err) {\n        this.uppy.log(\n          `[CompanionClient] unable to make preflight request ${err}`,\n          'warning',\n        )\n        // If the user gets a network error or similar, we should try preflight\n        // again next time, or else we might get incorrect behaviour.\n        allowedHeadersCache.delete(this.hostname) // re-fetch next time\n        return fallbackAllowedHeaders\n      }\n    })()\n\n    allowedHeadersCache.set(this.hostname, promise)\n    return promise\n  }\n\n  async preflightAndHeaders (path) {\n    const [allowedHeaders, headers] = await Promise.all([\n      this.preflight(path),\n      this.headers(),\n    ])\n    // filter to keep only allowed Headers\n    return Object.fromEntries(\n      Object.entries(headers).filter(([header]) => {\n        if (!allowedHeaders.includes(header.toLowerCase())) {\n          this.uppy.log(\n            `[CompanionClient] excluding disallowed header ${header}`,\n          )\n          return false\n        }\n        return true\n      }),\n    )\n  }\n\n  /** @protected */\n  async request ({ path, method = 'GET', data, skipPostResponse, signal }) {\n    try {\n      const headers = await this.preflightAndHeaders(path)\n      const response = await fetchWithNetworkError(this.#getUrl(path), {\n        method,\n        signal,\n        headers,\n        credentials: this.opts.companionCookiesRule || 'same-origin',\n        body: data ? JSON.stringify(data) : null,\n      })\n      if (!skipPostResponse) this.onReceiveResponse(response)\n      return handleJSONResponse(response)\n    } catch (err) {\n      if (err?.isAuthError) throw err\n      throw new ErrorWithCause(`Could not ${method} ${this.#getUrl(path)}`, {\n        cause: err,\n      })\n    }\n  }\n\n  async get (path, options = undefined) {\n    // TODO: remove boolean support for options that was added for backward compatibility.\n    // eslint-disable-next-line no-param-reassign\n    if (typeof options === 'boolean') options = { skipPostResponse: options }\n    return this.request({ ...options, path })\n  }\n\n  async post (path, data, options = undefined) {\n    // TODO: remove boolean support for options that was added for backward compatibility.\n    // eslint-disable-next-line no-param-reassign\n    if (typeof options === 'boolean') options = { skipPostResponse: options }\n    return this.request({ ...options, path, method: 'POST', data })\n  }\n\n  async delete (path, data = undefined, options) {\n    // TODO: remove boolean support for options that was added for backward compatibility.\n    // eslint-disable-next-line no-param-reassign\n    if (typeof options === 'boolean') options = { skipPostResponse: options }\n    return this.request({ ...options, path, method: 'DELETE', data })\n  }\n\n  async uploadRemoteFile (file, reqBody, options = {}) {\n    try {\n      if (file.serverToken) {\n        return await this.connectToServerSocket(file, this.getQueue())\n      }\n      const queueRequestSocketToken = this.getQueue().wrapPromiseFunction(\n        this.#requestSocketToken,\n        { priority: -1 },\n      )\n      const serverToken = await queueRequestSocketToken(file, reqBody).abortOn(\n        options.signal,\n      )\n\n      if (!this.uppy.getState().files[file.id]) return undefined\n\n      this.uppy.setFileState(file.id, { serverToken })\n      return await this.connectToServerSocket(\n        this.uppy.getFile(file.id),\n        this.getQueue(),\n      )\n    } catch (err) {\n      if (err?.cause?.name === 'AbortError') {\n        // The file upload was aborted, it’s not an error\n        return undefined\n      }\n\n      this.uppy.setFileState(file.id, { serverToken: undefined })\n      this.uppy.emit('upload-error', file, err)\n      throw err\n    }\n  }\n\n  #requestSocketToken = async (file, postBody) => {\n    if (file.remote.url == null) {\n      throw new Error('Cannot connect to an undefined URL')\n    }\n\n    const res = await this.post(file.remote.url, {\n      ...file.remote.body,\n      ...postBody,\n    })\n\n    return res.token\n  }\n\n  /**\n   * @param {UppyFile} file\n   */\n  async connectToServerSocket (file, queue) {\n    return new Promise((resolve, reject) => {\n      const token = file.serverToken\n      const host = getSocketHost(file.remote.companionUrl)\n      const socket = new Socket({\n        target: `${host}/api/${token}`,\n        autoOpen: false,\n      })\n      const eventManager = new EventManager(this.uppy)\n\n      let queuedRequest\n\n      eventManager.onFileRemove(file.id, () => {\n        socket.send('cancel', {})\n        queuedRequest.abort()\n        resolve(`upload ${file.id} was removed`)\n      })\n\n      eventManager.onPause(file.id, (isPaused) => {\n        if (isPaused) {\n          // Remove this file from the queue so another file can start in its place.\n          socket.send('pause', {})\n          queuedRequest.abort()\n        } else {\n          // Resuming an upload should be queued, else you could pause and then\n          // resume a queued upload to make it skip the queue.\n          queuedRequest.abort()\n          queuedRequest = queue.run(() => {\n            socket.open()\n            socket.send('resume', {})\n\n            return () => {}\n          })\n        }\n      })\n\n      eventManager.onPauseAll(file.id, () => {\n        socket.send('pause', {})\n        queuedRequest.abort()\n      })\n\n      eventManager.onCancelAll(file.id, ({ reason } = {}) => {\n        if (reason === 'user') {\n          socket.send('cancel', {})\n          queuedRequest.abort()\n        }\n        resolve(`upload ${file.id} was canceled`)\n      })\n\n      eventManager.onResumeAll(file.id, () => {\n        queuedRequest.abort()\n        if (file.error) {\n          socket.send('pause', {})\n        }\n        queuedRequest = queue.run(() => {\n          socket.open()\n          socket.send('resume', {})\n\n          return () => {}\n        })\n      })\n\n      eventManager.onRetry(file.id, () => {\n        // Only do the retry if the upload is actually in progress;\n        // else we could try to send these messages when the upload is still queued.\n        // We may need a better check for this since the socket may also be closed\n        // for other reasons, like network failures.\n        if (socket.isOpen) {\n          socket.send('pause', {})\n          socket.send('resume', {})\n        }\n      })\n\n      eventManager.onRetryAll(file.id, () => {\n        // See the comment in the onRetry() call\n        if (socket.isOpen) {\n          socket.send('pause', {})\n          socket.send('resume', {})\n        }\n      })\n\n      socket.on('progress', (progressData) => emitSocketProgress(this, progressData, file))\n\n      socket.on('error', (errData) => {\n        const { message } = errData.error\n        const error = Object.assign(new Error(message), {\n          cause: errData.error,\n        })\n\n        // If the remote retry optimisation should not be used,\n        // close the socket—this will tell companion to clear state and delete the file.\n        if (!this.opts.useFastRemoteRetry) {\n          // Remove the serverToken so that a new one will be created for the retry.\n          this.uppy.setFileState(file.id, {\n            serverToken: null,\n          })\n        } else {\n          socket.close()\n        }\n\n        this.uppy.emit('upload-error', file, error)\n        queuedRequest.done()\n        reject(error)\n      })\n\n      socket.on('success', (data) => {\n        const uploadResp = {\n          uploadURL: data.url,\n        }\n\n        this.uppy.emit('upload-success', file, uploadResp)\n        queuedRequest.done()\n        socket.close()\n        resolve()\n      })\n\n      queuedRequest = queue.run(() => {\n        if (file.isPaused) {\n          socket.send('pause', {})\n        } else {\n          socket.open()\n        }\n\n        return () => {}\n      })\n    })\n  }\n}\n"],"mappings":"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"}